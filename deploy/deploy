#!/bin/sh
# exit if any command fails
set -e

if [ "$KR_PRE_HOOK" != "" ]; then
  echo "Running pre hook command: $KR_PRE_HOOK"
  eval "$KR_PRE_HOOK"
fi

chart_version=${KR_CHART_VERSION:-0.3}
helm_version=${KR_HELM_VERSION:-3.1.1}
chart_ref=${KR_CHART_REF:-kube-review}

name="$KR_PREFIX-${KR_ID_OVERRIDE:-$KR_ID}"
short_name=$(echo -n $name | cut -c1-15)
hash=$(echo "$name" | rhash -p "%c" -)
namespace=re-$short_name-$hash
is_ephemeral=${KR_IS_EPHEMERAL:-true}
host=$namespace.$KR_DOMAIN
url=https://$host
kube_context=$KR_KUBE_CONTEXT
kube_config_file=$KR_KUBE_CONFIG_FILE
kube_logs_url=$KR_LOGS_URL
secrets_file=$KR_SECRETS_FILE
pull_request_number=$KR_PULL_REQUEST_NUMBER
branch_name=$KR_BRANCH_NAME
repo_name=$KR_REPO_NAME
repo_owner=$KR_REPO_OWNER
test_connection=${KR_TEST_CONNECTION:-true}

config_context() {
  # kubectl locks the config for each execution. To workaround
  # and allow multiple concurrent kubectl executions we copy the config
  scoped_kubeconfig_file=$kube_config_file-$namespace
  cp "$kube_config_file" "$scoped_kubeconfig_file"
  export KUBECONFIG=${scoped_kubeconfig_file}
  kubectl config use-context "$kube_context"
}

namespace_apply() {
  # Variables need to be export in order to be replaced by envsubst
  updated_at=$(date --utc +%s)
  export UPDATED_AT=$updated_at
  export NAMESPACE=$namespace
  export IS_EPHEMERAL=$is_ephemeral
  export PULL_REQUEST_NUMBER=$pull_request_number
  export BRANCH_NAME=$branch_name
  export REPO_NAME=$repo_name
  export REPO_OWNER=$repo_owner
  cat <<EOF | envsubst | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/name: kube-review
  annotations:
    app.kubernetes.io/instance: $NAMESPACE
    app.kubernetes.io/pull_request_number: "$PULL_REQUEST_NUMBER"
    app.kubernetes.io/branch_name: "$BRANCH_NAME"
    app.kubernetes.io/repository_name: "$REPO_NAME"
    app.kubernetes.io/repository_owner: "$REPO_OWNER"
    app.kubernetes.io/updated_at: "$UPDATED_AT"
    app.kubernetes.io/is_ephemeral: "$IS_EPHEMERAL"
  name: $NAMESPACE
EOF
}

apply_secret() {
  if [ "$secrets_file" != "" ]; then
    echo "Loading secrets file from: $secrets_file"
    kubectl create secret generic "$namespace" --from-env-file=$secrets_file \
      --dry-run=client -o yaml --save-config=true --namespace "$namespace" | kubectl apply -f -
  else
    echo "Not secrets file to load"
  fi
}

uninstall_chart() {
  # There is a problem in Helm v3 when it is necessary to update the helm graph
  # sometimes an UPGRADE_FAILED occurs, to fix it, we first of all need to remove the old version
  echo "Uninstalling old version of the helm chart: $namespace"
  helm uninstall -n "$namespace" "$namespace"
}

install_chart() {
  if [ "$KR_VALUES_FILE" != "" ]; then
    echo "Using values file from user: $KR_VALUES_FILE"
    export CUSTOMFILE_0="$KR_VALUES_FILE"
  fi

  # We need to use env here because of the CUSTOM vars
  # they have special charectes that export can't handle
  env \
  ACTION=install \
  CHART_REPO_URL="$KR_HELM_REPO_URL" \
  CHART_REF=$chart_ref \
  KUBE_CONTEXT="$kube_context" \
  RELEASE_NAME="$namespace" \
  CHART_VERSION="$chart_version" \
  HELM_VERSION=$helm_version \
  CUSTOM_image_tag="$KR_IMAGE_TAG" \
  CUSTOM_image_repository="$KR_IMAGE_URL" \
  CUSTOM_envFrom_secretRef_name="$namespace" \
  CUSTOM_"ingress_hosts[0]_host=$host" \
  CUSTOM_"ingress_hosts[0]_paths[0]=/" \
  CUSTOM_"ingress_tls[0]_hosts[0]=$host" \
  SKIP_CF_STABLE_HELM_REPO=true \
  WAIT=true \
  CMD_PS='--cleanup-on-fail' \
  /opt/bin/release_chart

  echo "Follow the logs from your deployment in Datadog:"
  echo "-----------------------------------------------"
  echo "$kube_logs_url$namespace"
}

test_chart() {
  if [ "$test_connection" = true ];
  then
    env ACTION=auth \
    SKIP_CF_STABLE_HELM_REPO=true \
    HELM_VERSION=$helm_version \
    CHART_VERSION="$chart_version" \
    KUBE_CONTEXT="$kube_context" \
    /opt/bin/release_chart
    helm test "$namespace" --namespace "$namespace"

    # It is necessary to remove the test pod from the helm test bacause HPA metrics may
    # fail when we have a pod with completed status.
    # Issue: https://github.com/kubernetes/kubernetes/issues/79365
    # Issues: https://github.com/kubernetes/kubernetes/issues?page=1&q=is%3Aissue+is%3Aopen+HPA
    echo "Removed the completed Test Pod.";
    kubectl delete pod --selector="app.kubernetes.io/managed-by=Helm" --namespace "$namespace"
  else
    echo "Connection test is disabled.";
  fi
}

export_variables() {
  # Export normally here so they are available to the post hook
  export URL=$url
}

config_context
namespace_apply
apply_secret
uninstall_chart || true
install_chart
test_chart
export_variables

if [ "$KR_POST_HOOK" != "" ]; then
  echo "Running post hook command: $KR_POST_HOOK"
  eval "$KR_POST_HOOK"
fi

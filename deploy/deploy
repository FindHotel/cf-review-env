#!/bin/sh
chart_version=0.2.0
helm_version=3.0.3
chart_ref=cf-review-env

export NAMESPACE=re-$NAME
kubectl config use-context $KUBE_CONTEXT
kubectl create namespace $NAMESPACE --dry-run -o yaml | kubectl apply -f -
kubectl create secret generic $NAMESPACE --from-env-file=/codefresh/volume/secrets.env --dry-run -o yaml --save-config=true --namespace $NAMESPACE | kubectl apply -f -
codefresh generate image-pull-secret --cluster $KUBE_CONTEXT --namespace $NAMESPACE --registry $APP_REGISTRY_NAME
imagePullSecrets=$(kubectl get secret --namespace $NAMESPACE -l io.codefresh.registry-name=$APP_REGISTRY_NAME \
    --field-selector='type=kubernetes.io/dockercfg' -o=jsonpath='{.items[0].metadata.name}')

if [ ! -z $APP_REGISTRY_NAME_SIDECAR ];
then
codefresh generate image-pull-secret --cluster $KUBE_CONTEXT --namespace $NAMESPACE --registry $APP_REGISTRY_NAME_SIDECAR
imagePullSecrets_sideCar=$(kubectl get secret --namespace $NAMESPACE -l io.codefresh.registry-name=$APP_REGISTRY_NAME_SIDECAR \
    --field-selector='type=kubernetes.io/dockercfg' -o=jsonpath='{.items[0].metadata.name}')
fi

# We need to use env here because of the CUSTOM vars
# they have special charectes that export can't handle
env \
ACTION=install \
CHART_REPO_URL=$HELM_REPO_URL \
CHART_REF=$chart_ref \
KUBE_CONTEXT=$KUBE_CONTEXT \
RELEASE_NAME=$NAME \
CHART_VERSION=$chart_version \
HELM_VERSION=$helm_version \
CUSTOM_image_tag=$APP_IMAGE_TAG \
CUSTOM_image_tagSideCar=$APP_IMAGE_TAG_SIDECAR \
CUSTOM_image_repository=$APP_IMAGE_URL \
CUSTOM_image_repositorySideCar=$APP_IMAGE_URL_SIDECAR \
CUSTOM_imagePullSecrets=$imagePullSecrets \
CUSTOM_imagePullSecretsSideCar=$imagePullSecrets_sideCar \
CUSTOM_envFrom_secretRef_name=$NAMESPACE \
CUSTOM_"ingress_hosts[0]_host=$NAMESPACE.$APP_DOMAIN" \
CUSTOM_"ingress_hosts[0]_paths[0]=$APP_INGRESS_PATH" \
CUSTOM_"ingress_tls[0]_secretName=$NAMESPACE-tls" \
CUSTOM_"ingress_tls[0]_hosts[0]=$NAMESPACE.$APP_DOMAIN" \
CUSTOM_"ingress_hosts[0]_paths[1]=$APP_INGRESS_PATH_SIDECAR" \
CUSTOMFILE_0=$VALUES_FILE \
SKIP_CF_STABLE_HELM_REPO=true \
WAIT=true \
/opt/bin/release_chart

env ACTION=auth \
SKIP_CF_STABLE_HELM_REPO=true \
HELM_VERSION=$helm_version \
CHART_VERSION=$chart_version \
KUBE_CONTEXT=$KUBE_CONTEXT \
/opt/bin/release_chart
helm test $NAME --namespace $NAMESPACE
